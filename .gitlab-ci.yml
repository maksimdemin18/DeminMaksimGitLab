workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG
stages:
  - fmt
  - lint
  - test
  - build
  - docker
  - deploy
default:
  tags: ["docker"]
variables:
  GOMODCACHE: "$CI_PROJECT_DIR/.cache/gomod"
  GOCACHE: "$CI_PROJECT_DIR/.cache/gobuild"
  CGO_ENABLED: "0"
cache:
  key:
    files:
      - go.sum
  paths:
    - .cache/
fmt:
  stage: fmt
  image: golang:1.22
  script:
    - test -f go.mod
    - diff -u <(echo -n) <(gofmt -l .)
  rules:
    - if: $CI_COMMIT_BRANCH || $CI_COMMIT_TAG
lint:
  stage: lint
  image: golang:1.22
  script:
    - go vet ./...
  rules:
    - if: $CI_COMMIT_BRANCH || $CI_COMMIT_TAG
test:
  stage: test
  image: golang:1.22
  script:
    - go test -v -coverprofile=coverage.out ./...
  artifacts:
    when: always
    paths:
      - coverage.out
  rules:
    - if: $CI_COMMIT_BRANCH || $CI_COMMIT_TAG
build:
  stage: build
  image: golang:1.22
  script:
    - mkdir -p bin
    - GOOS=linux GOARCH=amd64 go build -trimpath -ldflags "-s -w" -o bin/app .
  artifacts:
    paths:
      - bin/app
  rules:
    - if: $CI_COMMIT_BRANCH || $CI_COMMIT_TAG
docker-image:
  stage: docker
  image: docker:27
  script:
    - docker version
    - |
      if [[ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" || -n "$CI_COMMIT_TAG" ]]; then
        echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
        docker build -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA" -t "$CI_REGISTRY_IMAGE:latest" .
        docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
        docker push "$CI_REGISTRY_IMAGE:latest"
      else
        docker build -t "localbuild:$CI_COMMIT_SHORT_SHA" .
      fi
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG
deploy-staging:
  stage: deploy
  image: alpine:3.20
  script:
    - echo "Deploy placeholder. Configure SSH/k8s/ansible here."
  when: manual
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
